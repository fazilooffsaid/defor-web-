<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEFOR | –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .checkout-container { max-width: 900px; margin: 80px auto; padding: 0 20px; }
        .checkout-card { background: white; padding: 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .checkout-grid { display: grid; grid-template-columns: 1fr 400px; gap: 40px; }
        .order-item { display: flex; gap: 20px; padding: 20px; background: #f9f9f9; margin-bottom: 15px; border-radius: 8px; }
        .order-item img { width: 80px; height: 100px; object-fit: cover; flex-shrink: 0; }
        .order-item-name { font-weight: 600; font-size: 16px; margin-bottom: 5px; }
        .order-item-meta { font-size: 14px; color: #666; margin-bottom: 3px; }
        .order-item-price { font-size: 16px; font-weight: 600; color: #4a90e2; margin-top: 8px; }
        .order-summary { background: #1a2332; color: white; padding: 30px; border-radius: 8px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 15px; }
        .summary-total { font-size: 24px; font-weight: 700; padding-top: 15px; border-top: 2px solid rgba(255,255,255,0.2); margin-top: 15px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        input { width: 100%; padding: 16px; border: 1px solid #ddd; font-size: 15px; box-sizing: border-box; }
        input:focus { outline: none; border-color: #4a90e2; }
        .btn-submit { width: 100%; background: #4a90e2; color: white; border: none; padding: 20px; font-size: 14px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; margin-top: 20px; border-radius: 6px; }
        .btn-submit:hover { background: #357abd; }
        .success-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; }
        .success-modal.show { display: flex; }
        .success-content { background: white; padding: 40px; border-radius: 12px; text-align: center; max-width: 400px; }
        .success-icon { width: 80px; height: 80px; background: #27ae60; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; }
        .success-icon svg { width: 50px; height: 50px; fill: white; }
        .success-title { font-size: 24px; font-weight: 700; color: #27ae60; margin-bottom: 15px; }
        .success-message { font-size: 16px; color: #666; line-height: 1.6; }
        .btn-close-modal { background: #27ae60; color: white; border: none; padding: 12px 30px; font-size: 14px; font-weight: 600; border-radius: 6px; cursor: pointer; margin-top: 20px; }
        @media (max-width: 1024px) { .checkout-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo"><a href="index.html">DEFOR</a></div>
                <nav class="main-nav">
                    <a href="index.html" class="nav-link" data-i18n="nav-home">–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="new-arrivals.html" class="nav-link" data-i18n="nav-new">–ù–æ–≤–∏–Ω–∫–∏</a>
                    <a href="bags.html" class="nav-link" data-i18n="nav-bags">–°—É–º–∫–∏</a>
                    <a href="other.html" class="nav-link" data-i18n="nav-other">–î—Ä—É–≥–æ–µ</a>
                    <a href="accessories.html" class="nav-link" data-i18n="nav-accessories">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</a>
                </nav>
                <div class="header-icons">
                    <div class="lang-selector">
                        <button class="lang-btn" data-lang="ru">RU</button>
                        <button class="lang-btn" data-lang="uz">UZ</button>
                        <button class="lang-btn" data-lang="en">EN</button>
                    </div>
                    <button class="icon-btn cart-btn" onclick="window.location.href='cart.html'">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <path d="M16 10a4 4 0 0 1-8 0"></path>
                        </svg>
                        <span class="cart-count" id="cart-count">0</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="checkout-container">
        <div class="checkout-card">
            <h1 class="checkout-title" style="font-family:'Playfair Display',serif;font-size:32px;text-align:center;margin-bottom:40px;" data-i18n="checkout-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>

            <div class="checkout-grid">
                <div>
                    <h3 style="margin-bottom:20px;font-size:20px;" data-i18n="checkout-your-items">–í–∞—à–∏ —Ç–æ–≤–∞—Ä—ã</h3>
                    <div id="order-items"></div>

                    <h3 style="margin-bottom:20px;font-size:20px;margin-top:30px;" data-i18n="checkout-contacts">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>

                    <div class="form-group">
                        <label data-i18n="checkout-name-label">–í–ê–®–ï –ò–ú–Ø</label>
                        <input type="text" id="name" data-i18n-ph="checkout-name-placeholder" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="checkout-city-label">–ì–û–†–û–î</label>
                        <input type="text" id="city" data-i18n-ph="checkout-city-placeholder" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≥–æ—Ä–æ–¥" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="checkout-phone-label">–ù–û–ú–ï–† –¢–ï–õ–ï–§–û–ù–ê</label>
                        <input type="tel" id="phone" placeholder="+998 90 123 45 67" required>
                    </div>
                </div>

                <div>
                    <div class="order-summary">
                        <div style="font-size:20px;font-weight:600;margin-bottom:20px;" data-i18n="cart-summary-title">–ò—Ç–æ–≥–æ</div>
                        <div class="summary-row">
                            <span data-i18n="checkout-subtotal">–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –∏—Ç–æ–≥:</span>
                            <span id="subtotal">0 UZS</span>
                        </div>
                        <div class="summary-row summary-total">
                            <span data-i18n="checkout-total">–ò—Ç–æ–≥–æ:</span>
                            <span id="total">0 UZS</span>
                        </div>
                        <button class="btn-submit" id="submitOrderBtn" data-i18n="checkout-submit">–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –ó–ê–ö–ê–ó</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="successModal">
        <div class="success-content">
            <div class="success-icon">
                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
            </div>
            <div class="success-title" data-i18n="checkout-success-title">–ó–ê–ö–ê–ó –ü–û–î–¢–í–ï–†–ñ–î–ï–ù!</div>
            <div class="success-message" data-i18n="checkout-success-msg">–ú—ã —Å –≤–∞–º–∏ —Å–≤—è–∂–µ–º—Å—è</div>
            <button class="btn-close-modal" data-i18n="checkout-continue">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</button>
        </div>
    </div>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2026 DEFOR. <span data-i18n="footer-rights">–í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã</span></p>
            </div>
        </div>
    </footer>

    <style>
    .telegram-chat-widget { position: fixed; bottom: 30px; left: 30px; z-index: 9999; }
    .telegram-chat-button { width: 60px; height: 60px; background: linear-gradient(135deg, #0088cc, #00a6e8); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(0,136,204,0.4); text-decoration: none; transition: all 0.3s; }
    .telegram-chat-button:hover { transform: scale(1.1); }
    .telegram-chat-button svg { width: 32px; height: 32px; fill: white; }
    </style>
    <div class="telegram-chat-widget">
        <a href="https://t.me/faz1llooffss" target="_blank" class="telegram-chat-button">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/></svg>
        </a>
    </div>

    <script src="database.js"></script>
    <script src="app.js"></script>
    <script>
        const TELEGRAM_BOT_TOKEN = '8270542579:AAETTI3vH1eSY3LNpBAgKb0NCL6mOlgCUFw';
        const TELEGRAM_CHAT_ID = '-5183796333';

        const cart = getCart();
        if (cart.length === 0) window.location.href = 'cart.html';

        function renderOrderSummary() {
            const lang = (typeof getLang === 'function' ? getLang() : null) || localStorage.getItem('defor_lang') || 'ru';
            const colorLabel = { ru: '–¶–≤–µ—Ç', uz: 'Rang', en: 'Color' };
            const qtyLabel   = { ru: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', uz: 'Miqdor', en: 'Quantity' };
            const priceLabel = { ru: '–¶–µ–Ω–∞ –∑–∞ —à—Ç.', uz: 'Narxi', en: 'Price each' };
            const totalLabel = { ru: '–°—É–º–º–∞', uz: 'Jami', en: 'Subtotal' };

            document.getElementById('order-items').innerHTML = cart.map(item => {
                const unitPrice  = Number(item.price);
                const totalPrice = unitPrice * item.quantity;
                const color = item.selectedColor || (item.colors && item.colors[0] ? item.colors[0].name : '-');
                return `
                <div class="order-item">
                    <img src="${item.images && item.images[0] ? item.images[0] : ''}" alt="${item.title}">
                    <div>
                        <div class="order-item-name">${item.title}</div>
                        ${item.collection ? `<div class="order-item-meta">ID: ${item.collection}</div>` : ''}
                        <div class="order-item-meta">${colorLabel[lang]}: ${color}</div>
                        <div class="order-item-meta">${qtyLabel[lang]}: ${item.quantity}</div>
                        <div class="order-item-meta">${priceLabel[lang]}: ${unitPrice.toLocaleString('ru-RU')} UZS</div>
                        <div class="order-item-price">${totalLabel[lang]}: ${totalPrice.toLocaleString('ru-RU')} UZS</div>
                    </div>
                </div>`;
            }).join('');

            const grandTotal = getCartTotal();
            document.getElementById('subtotal').textContent = grandTotal.toLocaleString('ru-RU') + ' UZS';
            document.getElementById('total').textContent   = grandTotal.toLocaleString('ru-RU') + ' UZS';
        }

        async function sendToTelegram(message) {
            try {
                const res = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: message, parse_mode: 'HTML' })
                });
                return (await res.json()).ok;
            } catch(e) { return false; }
        }

        async function submitOrder() {
            const name  = document.getElementById('name').value.trim();
            const city  = document.getElementById('city').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const lang  = (typeof getLang === 'function' ? getLang() : null) || 'ru';
            const fillMsg = { ru: '‚ö† –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', uz: "‚ö† Barcha maydonlarni to'ldiring", en: '‚ö† Please fill all fields' };

            if (!name || !city || !phone) { alert(fillMsg[lang]); return; }

            const grandTotal  = getCartTotal();
            const orderNumber = 'ORD-' + Date.now();

            // ‚îÄ‚îÄ –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            let msg = `üõç <b>–ù–û–í–´–ô –ó–ê–ö–ê–ó!</b>\n`;
            msg += `üìã –ù–æ–º–µ—Ä: <code>${orderNumber}</code>\n`;
            msg += `üìÖ –î–∞—Ç–∞: ${new Date().toLocaleString('ru-RU')}\n\n`;
            msg += `üë§ <b>–ö–ª–∏–µ–Ω—Ç:</b>\n`;
            msg += `  –ò–º—è: ${name}\n`;
            msg += `  –ì–æ—Ä–æ–¥: ${city}\n`;
            msg += `  –¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n\n`;
            msg += `üì¶ <b>–¢–æ–≤–∞—Ä—ã:</b>\n`;

            cart.forEach((item, i) => {
                const unitPrice  = Number(item.price);
                const totalPrice = unitPrice * item.quantity;
                const color = item.selectedColor || (item.colors && item.colors[0] ? item.colors[0].name : '-');

                msg += `\n${i + 1}. <b>${item.title}</b>\n`;
                if (item.collection) msg += `   ID: ${item.collection}\n`;   // ‚Üê ID —Ç–æ–≤–∞—Ä–∞
                msg += `   –¶–≤–µ—Ç: ${color}\n`;
                msg += `   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity}\n`;
                msg += `   –¶–µ–Ω–∞ –∑–∞ —à—Ç.: ${unitPrice.toLocaleString('ru-RU')} UZS\n`;
                // –°—Ç—Ä–æ–∫—É "–°—É–º–º–∞" –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ > 1 —à—Ç.
                if (item.quantity > 1) {
                    msg += `   –°—É–º–º–∞: ${totalPrice.toLocaleString('ru-RU')} UZS\n`;
                }
            });

            msg += `\nüí∞ <b>–ò–¢–û–ì–û: ${grandTotal.toLocaleString('ru-RU')} UZS</b>`;
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑ (PostgreSQL / fallback localStorage)
            await saveOrder({
                customer: { name, city, phone },
                items: cart,
                total: grandTotal,
                orderNumber,
                orderDate: new Date().toISOString()
            });

            await sendToTelegram(msg);
            clearCart();

            document.getElementById('successModal').classList.add('show');
        }

        document.querySelector('.btn-close-modal').addEventListener('click', () => {
            document.getElementById('successModal').classList.remove('show');
            window.location.href = 'index.html';
        });

        document.getElementById('submitOrderBtn').addEventListener('click', submitOrder);

        renderOrderSummary();
        updateCartCount();
    </script>
    <script src="lang-switcher.js"></script>
</body>
</html>